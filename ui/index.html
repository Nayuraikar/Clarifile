<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Clarifile Quick UI</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; }
    button { margin: 4px; }
    .card { border: 1px solid #ddd; padding: 8px; margin:8px 0; border-radius:6px; }
    .flex { display:flex; gap:8px; align-items:center; }
    .chunks { margin-top:6px; padding:6px; background:#f9f9f9; border-radius:4px; }
  </style>
</head>
<body>
  <h2>Clarifile — Quick UI</h2>
  <div class="flex">
    <button id="btnScan">Scan</button>
    <button id="btnEmbed">Embed</button>
    <button id="btnReindex">Reindex</button>
    <button id="btnProposals">Show Proposals</button>
    <button id="btnDup">Show Duplicates</button>
    <button id="btnCategories">Show Categories</button>
  </div>

  <h3>Proposals</h3>
  <div id="proposals"></div>

  <h3>Duplicates</h3>
  <div id="duplicates"></div>

  <h3>Categories</h3>
  <div id="cats"></div>

<script>
const BASE = "http://127.0.0.1:8000";

async function call(path, opts) {
  const res = await fetch(BASE + path, opts);
  
  // If no content returned, return a default object
  if (res.status === 204) return { ok: true, message: "No content" };
  
  const text = await res.text();
  try {
    return JSON.parse(text);
  } catch(e) {
    console.error("Invalid JSON response:", text);
    return { error: "Invalid JSON from server", raw: text };
  }
}

document.getElementById('btnScan').onclick = async ()=>{
  const r = await call('/scan_folder', { method:'POST' });
  alert(JSON.stringify(r));
};

document.getElementById('btnEmbed').onclick = async ()=>{
  const r = await call('/embed', { method:'POST' });
  alert(JSON.stringify(r));
};

document.getElementById('btnReindex').onclick = async ()=>{
  const r = await call('/reindex', { method:'POST' });
  alert(JSON.stringify(r));
};

document.getElementById('btnProposals').onclick = async ()=>{
  const list = await call('/list_proposals');
  const container = document.getElementById('proposals');
  container.innerHTML = '';
  list.forEach(f=>{
    const id = f.id;
    const file_name = f.file || '(no name)';
    const proposed_label = f.proposed || 'Uncategorized';
    const status = f.final || '';
    
    const div = document.createElement('div');
    div.className='card';
    div.innerHTML = `<strong>${file_name}</strong><br>
      Proposed: <em>${proposed_label}</em> — Status: ${status} <br>
      <button data-id="${id}" data-label="${proposed_label}" class="approve">Approve as ${proposed_label}</button>
      <input placeholder="Custom label" id="lbl${id}" style="margin-left:8px"/>
      <button data-id="${id}" class="approveCustom">Approve Custom</button>
      <button data-id="${id}" class="viewSummary">View Summary</button>
      <button data-id="${id}" class="viewTags">Show Tags</button>
      <div style="margin-top:6px">
        <input id="q${id}" placeholder="Ask a question about this file..." style="width:60%"/>
        <button data-id="${id}" class="askQA">Ask</button>
      </div>
      <div id="summary${id}" class="chunks" style="display:none"></div>
      <div id="tags${id}" class="chunks" style="display:none"></div>
      <div id="qa${id}" class="chunks" style="display:none"></div>`;
    container.appendChild(div);
  });
  
  // attach handlers
  document.querySelectorAll('.approve').forEach(b=>{
    b.onclick = async (e)=>{
      const id = b.dataset.id; 
      const label = b.dataset.label || 'Uncategorized';
      const r = await call('/approve', { 
        method:'POST', 
        headers:{'Content-Type':'application/json'}, 
        body: JSON.stringify({file_id: parseInt(id), final_label: label})
      });
      alert(JSON.stringify(r));
    };
  });
  
  document.querySelectorAll('.approveCustom').forEach(b=>{
    b.onclick = async ()=>{
      const id = b.dataset.id;
      const lbl = document.getElementById('lbl'+id).value || 'Uncategorized';
      const r = await call('/approve', { 
        method:'POST', 
        headers:{'Content-Type':'application/json'}, 
        body: JSON.stringify({file_id: parseInt(id), final_label: lbl})
      });
      alert(JSON.stringify(r));
    };
  });
  
  document.querySelectorAll('.viewSummary').forEach(b=>{
    b.onclick = async ()=>{
      const id = b.dataset.id;
      const r = await fetch(`${BASE}/file_summary?file_id=${id}`);
      if(r.status===200){
        const j = await r.json();
        const div = document.getElementById('summary'+id);
        div.innerText = j.summary || '(no summary)';
        div.style.display = 'block';
      }else{
        alert("No summary for file "+id);
      }
    };
  });

  document.querySelectorAll('.viewTags').forEach(b=>{
    b.onclick = async ()=>{
      const id = b.dataset.id;
      const r = await fetch(`${BASE}/file_entities?file_id=${id}`);
      const j = await r.json();
      const div = document.getElementById('tags'+id);
      div.innerHTML = j.length ? j.map(e=>`${e.name} (${e.type} x${e.count})`).join(' • ') : '(no tags found)';
      div.style.display = 'block';
    };
  });

  document.querySelectorAll('.askQA').forEach(b=>{
    b.onclick = async ()=>{
      const id = b.dataset.id;
      const q = document.getElementById('q'+id).value.trim();
      if(!q) return alert('Type a question');
      const r = await fetch(`${BASE}/ask?file_id=${id}&q=${encodeURIComponent(q)}`);
      const j = await r.json();
      const div = document.getElementById('qa'+id);
      div.innerHTML = j.ok ? `<b>Answer:</b> ${j.answer}<br><small>score: ${j.score.toFixed(3)}</small>` : j.error;
      div.style.display = 'block';
    };
  });
};

document.getElementById('btnDup').onclick = async ()=>{
  const d = await call('/duplicates');
  const container = document.getElementById('duplicates');
  container.innerHTML = '';

  const allGroups = d.duplicates || [];

  if(allGroups.length === 0){
    container.innerText = 'No duplicate candidates found.';
    return;
  }

  function makePair(group) {
    const div = document.createElement('div');
    div.className = 'card';

    let inner = `<strong>Duplicate group ${group.group_id || ''}</strong> (${group.file_count} files)<br>`;
    inner += `<em>Files with identical text content:</em><br>`;

    for (let i = 0; i < group.files.length; i++) {
      for (let j = i+1; j < group.files.length; j++) {
        inner += `A: ${group.files[i].name} — B: ${group.files[j].name}<br>
          <button data-a="${group.files[i].id}" data-b="${group.files[j].id}" data-action="keep_a">Keep A</button>
          <button data-a="${group.files[i].id}" data-b="${group.files[j].id}" data-action="keep_b">Keep B</button>
          <button data-a="${group.files[i].id}" data-b="${group.files[j].id}" data-action="keep_both">Keep Both</button><br>`;
      }
    }

    div.innerHTML = inner;
    container.appendChild(div);
  }

  allGroups.forEach(g => makePair(g));

  container.querySelectorAll('button').forEach(b=>{
    b.onclick = async ()=>{
      const file_a = parseInt(b.dataset.a);
      const file_b = parseInt(b.dataset.b);
      const action = b.dataset.action;
      const r = await call('/resolve_duplicate', { 
        method:'POST', 
        headers:{'Content-Type':'application/json'}, 
        body: JSON.stringify({file_a,file_b,action})
      });
      alert(JSON.stringify(r));
    };
  });
};

document.getElementById('btnCategories').onclick = async ()=>{
  const r = await fetch(`${BASE}/categories`);
  const cats = await r.json();
  const el = document.getElementById('cats');
  el.innerHTML = '';
  cats.forEach(c=>{
    const d = document.createElement('div');
    d.className='card';
    d.innerHTML = `<strong>${c.category}</strong> — ${c.file_count}`;
    el.appendChild(d);
  });
};

</script>
</body>
</html>